<% content_for(:breadcrumb) do %>
   
  <%= link_to "Users", admin_users_path %> > 
  <strong><%= @user.email %></strong>
<% end %>

<div class="admin-page-header">
  <h1 class="admin-page-title">User Details</h1>
  <div style="display: flex; gap: 0.5rem;">
    <% unless @user == current_user %>
      <%= link_to "Edit", edit_admin_user_path(@user), class: "admin-nav-link", 
          style: "margin-right: 0.5rem;" %>
      <%= form_with model: [:admin, @user], local: true, method: :delete, 
          data: { turbo_confirm: "Are you sure you want to delete this user? This action cannot be undone." },
          style: "display: inline;" do |form| %>
        <%= form.submit "Delete", style: "background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; border: none; cursor: pointer; height: 100%" %>
      <% end %>
    <% end %>
  </div>
</div>

<div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- User Information -->
    <div class="admin-section">
      <div style="background: #f0ebe4; padding: 1rem; border-bottom: 1px solid #8b7355; margin: -1rem -1rem 1rem -1rem;">
        <h3 style="margin: 0; color: #3d2c1d;">User Information</h3>
      </div>
      
      <div>
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Name:</strong>
          <span style="color: #3d2c1d;"><%= @user.full_name %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Email:</strong>
          <span style="color: #3d2c1d;"><%= @user.email %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Role:</strong>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="background: <%= @user.admin? ? '#f0ebe4' : '#fefcfa' %>; 
                       color: <%= @user.admin? ? '#8b4513' : '#3d2c1d' %>; 
                       padding: 0.25rem 0.75rem; border-radius: 16px; font-weight: 500; border: 1px solid #8b7355;">
              <%= @user.role.humanize %>
            </span>
            <% unless @user == current_user %>
              <div style="display: flex; gap: 0.25rem;">
                <% if @user.commentor? %>
      <%= button_to "Make Admin",
        update_role_admin_user_path(@user, role: 'admin'),
        method: :patch,
        form: { style: "display:inline", data: { turbo_confirm: "Are you sure you want to make this user an admin?" } },
                        form_class: "inline",
                        class: "",
                        style: "background: #8b4513; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; text-decoration: none; font-size: 0.75rem; border: none; cursor: pointer;" %>
                <% else %>
      <%= button_to "Make Commentor",
        update_role_admin_user_path(@user, role: 'commentor'),
        method: :patch,
        form: { style: "display:inline", data: { turbo_confirm: "Are you sure you want to change this user to commentor?" } },
                        form_class: "inline",
                        class: "",
                        style: "background: #8b7355; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; text-decoration: none; font-size: 0.75rem; border: none; cursor: pointer;" %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Provider:</strong>
          <span style="color: #3d2c1d;"><%= @user.provider&.humanize || "Email" %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">UID:</strong>
          <span style="font-family: monospace; font-size: 0.875rem; color: #3d2c1d;"><%= @user.uid || "‚Äî" %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Joined:</strong>
          <div>
            <span style="color: #3d2c1d;"><%= @user.created_at.strftime("%B %d, %Y at %I:%M %p") %></span>
            <br><small style="color: #8b7355;"><%= time_ago_in_words(@user.created_at) %> ago</small>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong style="color: #3d2c1d;">Last Sign In:</strong>
          <div>
            <% if @user.current_sign_in_at %>
              <span style="color: #3d2c1d;"><%= @user.current_sign_in_at.strftime("%B %d, %Y at %I:%M %p") %></span>
              <br><small style="color: #8b7355;"><%= time_ago_in_words(@user.current_sign_in_at) %> ago</small>
            <% else %>
              <span style="color: #8b7355;">Never signed in</span>
            <% end %>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem;">
          <strong style="color: #3d2c1d;">Sign In Count:</strong>
          <span style="color: #3d2c1d;"><%= @user.sign_in_count || 0 %></span>
        </div>
      </div>
    </div>

    <!-- Streak Management -->
    <div class="admin-section">
      <div style="background: #f0ebe4; padding: 1rem; border-bottom: 1px solid #8b7355; margin: -1rem -1rem 1rem -1rem;">
        <h3 style="margin: 0; color: #3d2c1d;">Login Streak Management</h3>
      </div>
      
      <div>
        <!-- Streak Display -->
        <div style="background: #fefcfa; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #8b7355; text-align: center;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
            <span style="font-size: 2rem;"><%= @user.streak_emoji %></span>
            <div>
              <div style="font-size: 1.5rem; font-weight: bold; color: #3d2c1d;"><%= @user.streak_display %></div>
              <% if @user.has_longest_streak_record? %>
                <div style="font-size: 0.875rem; color: #8b7355;">Personal record: <%= @user.longest_streak %> days üèÜ</div>
              <% end %>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <div style="font-size: 0.875rem; color: #8b7355; margin-bottom: 0.25rem;">Current Streak</div>
              <div style="font-size: 1.25rem; font-weight: bold; color: #ff6b35;"><%= @user.current_streak %></div>
            </div>
            <div>
              <div style="font-size: 0.875rem; color: #8b7355; margin-bottom: 0.25rem;">Longest Streak</div>
              <div style="font-size: 1.25rem; font-weight: bold; color: #8b7355;"><%= @user.longest_streak %></div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div>
              <div style="font-size: 0.875rem; color: #8b7355; margin-bottom: 0.25rem;">Timezone</div>
              <div style="font-size: 0.875rem; color: #3d2c1d; font-family: monospace;"><%= @user.streak_timezone %></div>
            </div>
            <div>
              <div style="font-size: 0.875rem; color: #8b7355; margin-bottom: 0.25rem;">Last Login Date</div>
              <div style="font-size: 0.875rem; color: #3d2c1d;">
                <%= @user.last_login_date&.strftime("%b %d, %Y") || "Never" %>
              </div>
            </div>
          </div>
        </div>

        <!-- Streak Actions -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <%= button_to "Reset Streak", reset_streak_admin_user_path(@user), 
              method: :patch,
              form: { data: { turbo_confirm: "Are you sure you want to reset this user's streak to 0?" } },
              style: "background: #dc2626; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; width: 100%;" %>
          
          <%= button_to "Recalculate Streak", recalculate_streak_admin_user_path(@user), 
              method: :patch,
              form: { data: { turbo_confirm: "Recalculate streak based on login history?" } },
              style: "background: #059669; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; width: 100%;" %>
        </div>

        <!-- Manual Streak Update -->
        <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; border: 1px solid #8b7355;">
          <h4 style="margin: 0 0 1rem 0; color: #3d2c1d; font-size: 0.875rem;">Manual Update</h4>
          <%= form_with url: update_streak_admin_user_path(@user), method: :patch, 
              style: "display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;" do |f| %>
            <div>
              <%= f.label :current_streak, "Current Streak", style: "font-size: 0.75rem; color: #8b7355; display: block;" %>
              <%= f.number_field :current_streak, value: @user.current_streak, min: 0,
                  style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
            </div>
            <div>
              <%= f.label :longest_streak, "Longest Streak", style: "font-size: 0.75rem; color: #8b7355; display: block; margin-top: 0.5rem;" %>
              <%= f.number_field :longest_streak, value: @user.longest_streak, min: 0,
                  style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
            </div>
            <%= f.submit "Update", 
                style: "background: #8b7355; color: white; padding: 0.5rem 1rem; border-radius: 4px; border: none; cursor: pointer; height: fit-content; margin-top: 0.5rem;" %>
          <% end %>
        </div>
      </div>
    </div>

    <!-- Activity Summary -->
    <div class="admin-section">
      <div style="background: #f0ebe4; padding: 1rem; border-bottom: 1px solid #8b7355; margin: -1rem -1rem 1rem -1rem;">
        <h3 style="margin: 0; color: #3d2c1d;">Activity Summary</h3>
      </div>
      
      <div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #8b7355;">
            <h4 style="margin: 0; color: #3d2c1d; font-size: 0.875rem;">Total Activities</h4>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #3d2c1d;"><%= @user_activities.count %></p>
          </div>
          
          <div style="background: #fefcfa; padding: 1rem; border-radius: 8px; text-align: center; border: 1px solid #8b7355;">
            <h4 style="margin: 0; color: #3d2c1d; font-size: 0.875rem;">Last 7 Days</h4>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #8b7355;"><%= @user_activities.where('created_at > ?', 7.days.ago).count %></p>
          </div>
        </div>
        
        <% if @user_activities.any? %>
          <h4 style="margin: 0 0 1rem 0; color: #3d2c1d;">Recent Activities</h4>
          <% @user_activities.limit(5).each do |activity| %>
            <div style="border-bottom: 1px solid #8b7355; padding: 0.75rem 0;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <span style="background: #f0ebe4; color: #3d2c1d; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500; border: 1px solid #8b7355;">
                    <%= activity.action_description %>
                  </span>
                  <% if activity.target %>
                    <div style="color: #8b7355; font-size: 0.875rem; margin-top: 0.25rem;">
                      <%= activity.target.class.name %>: <%= truncate(activity.target_description, length: 40) %>
                    </div>
                  <% end %>
                </div>
                <small style="color: #8b7355; white-space: nowrap; margin-left: 1rem;">
                  <%= time_ago_in_words(activity.created_at) %> ago
                </small>
              </div>
            </div>
          <% end %>
          
          <div style="text-align: center; margin-top: 1rem;">
            <%= link_to "View All Activities", admin_activity_logs_path(user_id: @user.id), 
                style: "color: #8b7355; text-decoration: none; font-size: 0.875rem;" %>
          </div>
        <% else %>
          <p style="text-align: center; color: #8b7355; padding: 2rem;">No activities recorded</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Current Status -->
  <% if @user == current_user %>
    <div style="background: #f0ebe4; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #8b7355; margin-top: 2rem;">
      <h4 style="margin: 0 0 0.5rem 0; color: #3d2c1d;">Current User</h4>
      <p style="margin: 0; color: #3d2c1d;">This is your own user account. Some administrative actions are restricted for security.</p>
    </div>
  <% end %>

  <!-- Quick Actions -->
  <div style="background: #f0ebe4; padding: 1.5rem; border-radius: 8px; margin-top: 2rem; border-left: 4px solid #8b7355;">
    <h4 style="margin: 0 0 1rem 0; color: #3d2c1d;">Quick Actions</h4>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <%= link_to "Back to Users", admin_users_path, 
          style: "background: #8b7355; color: #fefcfa; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; border: 1px solid #3d2c1d;" %>
      
      <% unless @user == current_user %>
        <%= link_to "Edit User", edit_admin_user_path(@user), 
            style: "background: #8b7355; color: #fefcfa; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; border: 1px solid #3d2c1d;" %>
      <% end %>
      
      <%= link_to "View Activities", admin_activity_logs_path(user_id: @user.id), 
          style: "background: #8b7355; color: #fefcfa; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; border: 1px solid #3d2c1d;" %>
      
      <% if @user.admin? %>
        <%= link_to "Filter Admin Actions", admin_activity_logs_path(user_id: @user.id, action: 'dashboard_view'), 
            style: "background: #ff9800; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
      <% end %>
    </div>
  </div>
</div>
