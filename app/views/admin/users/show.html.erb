<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > 
  <%= link_to "Users", admin_users_path %> > 
  <strong><%= @user.email %></strong>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>User Details</h1>
  <div>
    <% unless @user == current_user %>
      <%= link_to "Edit", edit_admin_user_path(@user), 
          style: "background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none; margin-right: 0.5rem;" %>
      <%= link_to "Delete", admin_user_path(@user), method: :delete,
          confirm: "Are you sure you want to delete this user?",
          style: "background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
    <% end %>
  </div>
</div>

<div style="max-width: 1000px;">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
    <!-- User Information -->
    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="background: #f8f9fa; padding: 1rem; border-bottom: 1px solid #dee2e6;">
        <h3 style="margin: 0;">User Information</h3>
      </div>
      
      <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>Email:</strong>
          <span><%= @user.email %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>Role:</strong>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="background: <%= @user.admin? ? '#fff3e0' : '#e8f5e8' %>; 
                       color: <%= @user.admin? ? '#ef6c00' : '#2e7d32' %>; 
                       padding: 0.25rem 0.75rem; border-radius: 16px; font-weight: 500;">
              <%= @user.role.humanize %>
            </span>
            <% unless @user == current_user %>
              <div style="display: flex; gap: 0.25rem;">
                <% if @user.commentor? %>
                  <%= link_to "Make Admin", update_role_admin_user_path(@user, role: 'admin'), method: :patch,
                      style: "background: #ffc107; color: #212529; padding: 0.125rem 0.5rem; border-radius: 4px; text-decoration: none; font-size: 0.75rem;" %>
                <% else %>
                  <%= link_to "Make Commentor", update_role_admin_user_path(@user, role: 'commentor'), method: :patch,
                      style: "background: #17a2b8; color: white; padding: 0.125rem 0.5rem; border-radius: 4px; text-decoration: none; font-size: 0.75rem;" %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>Provider:</strong>
          <span><%= @user.provider&.humanize || "Email" %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>UID:</strong>
          <span style="font-family: monospace; font-size: 0.875rem;"><%= @user.uid || "â€”" %></span>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>Joined:</strong>
          <div>
            <%= @user.created_at.strftime("%B %d, %Y at %I:%M %p") %>
            <br><small style="color: #6c757d;"><%= time_ago_in_words(@user.created_at) %> ago</small>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem; margin-bottom: 1rem;">
          <strong>Last Sign In:</strong>
          <div>
            <% if @user.current_sign_in_at %>
              <%= @user.current_sign_in_at.strftime("%B %d, %Y at %I:%M %p") %>
              <br><small style="color: #6c757d;"><%= time_ago_in_words(@user.current_sign_in_at) %> ago</small>
            <% else %>
              <span style="color: #6c757d;">Never signed in</span>
            <% end %>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 1rem;">
          <strong>Sign In Count:</strong>
          <span><%= @user.sign_in_count || 0 %></span>
        </div>
      </div>
    </div>

    <!-- Activity Summary -->
    <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
      <div style="background: #f8f9fa; padding: 1rem; border-bottom: 1px solid #dee2e6;">
        <h3 style="margin: 0;">Activity Summary</h3>
      </div>
      
      <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
          <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #1565c0; font-size: 0.875rem;">Total Activities</h4>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #0d47a1;"><%= @user_activities.count %></p>
          </div>
          
          <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; text-align: center;">
            <h4 style="margin: 0; color: #2e7d32; font-size: 0.875rem;">Last 7 Days</h4>
            <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #1b5e20;"><%= @user_activities.where('created_at > ?', 7.days.ago).count %></p>
          </div>
        </div>
        
        <% if @user_activities.any? %>
          <h4 style="margin: 0 0 1rem 0;">Recent Activities</h4>
          <% @user_activities.limit(5).each do |activity| %>
            <div style="border-bottom: 1px solid #e9ecef; padding: 0.75rem 0;">
              <div style="display: flex; justify-content: between; align-items: start;">
                <div style="flex: 1;">
                  <span style="background: #e6fffa; color: #234e52; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 500;">
                    <%= activity.action_description %>
                  </span>
                  <% if activity.target %>
                    <div style="color: #6c757d; font-size: 0.875rem; margin-top: 0.25rem;">
                      <%= activity.target.class.name %>: <%= truncate(activity.target_description, length: 40) %>
                    </div>
                  <% end %>
                </div>
                <small style="color: #6c757d; white-space: nowrap; margin-left: 1rem;">
                  <%= time_ago_in_words(activity.created_at) %> ago
                </small>
              </div>
            </div>
          <% end %>
          
          <div style="text-align: center; margin-top: 1rem;">
            <%= link_to "View All Activities", admin_activity_logs_path(user_id: @user.id), 
                style: "color: #007bff; text-decoration: none; font-size: 0.875rem;" %>
          </div>
        <% else %>
          <p style="text-align: center; color: #6c757d; padding: 2rem;">No activities recorded</p>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Current Status -->
  <% if @user == current_user %>
    <div style="background: #e8f4fd; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #2196f3; margin-top: 2rem;">
      <h4 style="margin: 0 0 0.5rem 0; color: #1565c0;">Current User</h4>
      <p style="margin: 0; color: #1976d2;">This is your own user account. Some administrative actions are restricted for security.</p>
    </div>
  <% end %>

  <!-- Quick Actions -->
  <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-top: 2rem;">
    <h4 style="margin: 0 0 1rem 0; color: #2d3748;">Quick Actions</h4>
    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
      <%= link_to "Back to Users", admin_users_path, 
          style: "background: #6c757d; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
      
      <% unless @user == current_user %>
        <%= link_to "Edit User", edit_admin_user_path(@user), 
            style: "background: #2196f3; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
      <% end %>
      
      <%= link_to "View Activities", admin_activity_logs_path(user_id: @user.id), 
          style: "background: #4caf50; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
      
      <% if @user.admin? %>
        <%= link_to "Filter Admin Actions", admin_activity_logs_path(user_id: @user.id, action: 'dashboard_view'), 
            style: "background: #ff9800; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
      <% end %>
    </div>
  </div>
</div>
