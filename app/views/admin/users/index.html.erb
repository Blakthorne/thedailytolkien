<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > <strong>Users</strong>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>Manage Users</h1>
  <div>
    <%= link_to "Export CSV", admin_users_path(format: :csv), 
        style: "background: #6c757d; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
  </div>
</div>

<!-- Search and Filter Bar -->
<div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
  <%= form_with url: admin_users_path, method: :get, local: true, 
      style: "display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;" do |f| %>
    <%= f.text_field :search, placeholder: "Search by email...", 
        value: params[:search],
        style: "flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" %>
    <%= f.select :role, [["All Roles", ""], ["Admin", "admin"], ["Commentor", "commentor"]], 
        { selected: params[:role] },
        { style: "padding: 0.5rem; border: 1px solid #ced4da; border-radius: 4px;" } %>
    <%= f.submit "Search", 
        style: "background: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer;" %>
    <% if params[:search].present? || params[:role].present? %>
      <%= link_to "Clear", admin_users_path, 
          style: "background: #6c757d; color: white; padding: 0.5rem 1rem; border-radius: 4px; text-decoration: none;" %>
    <% end %>
  <% end %>
</div>

<!-- User Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div style="background: #e3f2fd; padding: 1rem; border-radius: 8px; text-align: center;">
    <h4 style="margin: 0; color: #1565c0;">Total Users</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #0d47a1;"><%= User.count %></p>
  </div>
  
  <div style="background: #fff3e0; padding: 1rem; border-radius: 8px; text-align: center;">
    <h4 style="margin: 0; color: #ef6c00;">Admins</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #e65100;"><%= User.admin.count %></p>
  </div>
  
  <div style="background: #e8f5e8; padding: 1rem; border-radius: 8px; text-align: center;">
    <h4 style="margin: 0; color: #2e7d32;">Commentors</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #1b5e20;"><%= User.commentor.count %></p>
  </div>
  
  <div style="background: #f3e5f5; padding: 1rem; border-radius: 8px; text-align: center;">
    <h4 style="margin: 0; color: #7b1fa2;">This Week</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #4a148c;"><%= User.where('created_at > ?', 1.week.ago).count %></p>
  </div>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_action_admin_users_path, method: :post, local: true, id: "bulk-form" do |f| %>
  <div style="background: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none;" id="bulk-actions">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <span>Selected: <strong id="selected-count">0</strong> users</span>
      <%= f.select :bulk_action, [
            ["Make Admin", "make_admin"],
            ["Make Commentor", "make_commentor"],
            ["Delete Selected", "delete"]
          ], { prompt: "Choose action..." },
          { style: "padding: 0.25rem; border: 1px solid #ced4da; border-radius: 4px;" } %>
      <%= f.submit "Apply", 
          style: "background: #dc3545; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;",
          onclick: "return confirm('Are you sure you want to perform this action on the selected users?')" %>
      <button type="button" onclick="clearSelection()" 
              style="background: #6c757d; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="background: #f8f9fa;">
        <tr>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">
            <input type="checkbox" id="select-all" onchange="toggleAll(this)">
          </th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Email</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Role</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Provider</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Joined</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Last Seen</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #dee2e6;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @users.any? %>
          <% @users.each do |user| %>
            <tr style="border-bottom: 1px solid #dee2e6;">
              <td style="padding: 1rem;">
                <% unless user == current_user %>
                  <%= check_box_tag "user_ids[]", user.id, false, 
                      class: "user-checkbox", onchange: "updateBulkActions()" %>
                <% end %>
              </td>
              <td style="padding: 1rem;">
                <div>
                  <strong><%= user.email %></strong>
                  <% if user == current_user %>
                    <span style="background: #e3f2fd; color: #1565c0; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">
                      You
                    </span>
                  <% end %>
                </div>
              </td>
              <td style="padding: 1rem;">
                <span style="background: <%= user.admin? ? '#fff3e0' : '#e8f5e8' %>; 
                           color: <%= user.admin? ? '#ef6c00' : '#2e7d32' %>; 
                           padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.875rem; font-weight: 500;">
                  <%= user.role.humanize %>
                </span>
              </td>
              <td style="padding: 1rem;">
                <span style="color: #6c757d; font-size: 0.875rem;">
                  <%= user.provider&.humanize || "Email" %>
                </span>
              </td>
              <td style="padding: 1rem;">
                <small style="color: #6c757d;">
                  <%= time_ago_in_words(user.created_at) %> ago
                  <br><%= user.created_at.strftime("%b %d, %Y") %>
                </small>
              </td>
              <td style="padding: 1rem;">
                <small style="color: #6c757d;">
                  <% if user.current_sign_in_at %>
                    <%= time_ago_in_words(user.current_sign_in_at) %> ago
                    <br><%= user.current_sign_in_at.strftime("%b %d, %Y") %>
                  <% else %>
                    Never signed in
                  <% end %>
                </small>
              </td>
              <td style="padding: 1rem;">
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                  <%= link_to "View", admin_user_path(user), 
                      style: "color: #007bff; text-decoration: none; font-size: 0.875rem;" %>
                  <% unless user == current_user %>
                    <%= link_to "Edit", edit_admin_user_path(user), 
                        style: "color: #28a745; text-decoration: none; font-size: 0.875rem;" %>
                    <%= link_to "Delete", admin_user_path(user), method: :delete,
                        confirm: "Are you sure you want to delete this user?",
                        style: "color: #dc3545; text-decoration: none; font-size: 0.875rem;" %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" style="padding: 3rem; text-align: center; color: #6c757d;">
              <% if params[:search].present? || params[:role].present? %>
                No users found matching your criteria
                <br><br>
                <%= link_to "Clear filters", admin_users_path, 
                    style: "color: #007bff; text-decoration: none;" %>
              <% else %>
                No users found
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<script>
function toggleAll(checkbox) {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.user-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  selectedCount.textContent = checked.length;
  
  if (checked.length > 0) {
    bulkActions.style.display = 'block';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectAll = document.getElementById('select-all');
  selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
  selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
}

function clearSelection() {
  document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateBulkActions();
}
</script>
