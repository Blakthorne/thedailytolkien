<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > <strong>Users</strong>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>Manage Users</h1>
  <div>
    <%= link_to "Export CSV", admin_users_path(format: :csv), class: "admin-nav-link" %>
  </div>
</div>

<!-- Search and Filter Bar -->
<div class="admin-section" style="margin-bottom: 2rem;">
  <%= form_with url: admin_users_path, method: :get, local: true, 
      style: "display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;" do |f| %>
    <%= f.text_field :search, placeholder: "Search by email...", 
        value: params[:search],
        style: "flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
    <%= f.select :role, [["All Roles", ""], ["Admin", "admin"], ["Commentor", "commentor"]], 
        { selected: params[:role] },
        { style: "padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
    <%= f.submit "Search", class: "admin-nav-link" %>
    <% if params[:search].present? || params[:role].present? %>
      <%= link_to "Clear", admin_users_path, class: "admin-nav-link" %>
    <% end %>
  <% end %>
</div>

<!-- User Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Total Users</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Admins</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.admin.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Commentors</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.commentor.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">This Week</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #4a148c;"><%= User.where('created_at > ?', 1.week.ago).count %></p>
  </div>

  <div class="admin-stat-card">
    <h4 style="margin: 0;">Active Streaks</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #ff6b35;"><%= User.where('current_streak > 0').count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Max Streak</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #8b7355;"><%= User.maximum(:longest_streak) || 0 %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Avg Streak</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #6b46c1;"><%= User.average(:current_streak)&.round(1) || 0 %></p>
  </div>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_action_admin_users_path, method: :post, local: true, id: "bulk-form" do |f| %>
  <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border: 1px solid #8b7355;" id="bulk-actions">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <span style="color: #3d2c1d;">Selected: <strong id="selected-count">0</strong> users</span>
      <%= f.select :bulk_action, [
            ["Make Admin", "make_admin"],
            ["Make Commentor", "make_commentor"],
            ["Reset Streaks", "reset_streaks"],
            ["Recalculate Streaks", "recalculate_streaks"],
            ["Delete Selected", "delete"]
          ], { prompt: "Choose action..." },
          { style: "padding: 0.25rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      <%= f.submit "Apply", 
          style: "background: #8b4513; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;",
          onclick: "return confirm('Are you sure you want to perform this action on the selected users?')" %>
      <button type="button" onclick="clearSelection()" 
              style="background: #8b7355; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Users Table -->
  <div class="admin-section">
    <table style="width: 100%; border-collapse: collapse;" data-controller="sortable-table" aria-describedby="users-table-caption">
      <caption id="users-table-caption" class="sr-only">Users table. Click on headers to sort. Click a row to view details.</caption>
      <thead style="background: #f0ebe4;">
        <tr>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">
            <input type="checkbox" id="select-all" onchange="toggleAll(this)">
          </th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Email</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Role</th>
          <th data-type="number" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: center; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Current Streak</th>
          <th data-type="number" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: center; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Best Streak</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Provider</th>
          <th data-type="date" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Joined</th>
          <th data-type="date" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Last Seen</th>
        </tr>
      </thead>
      <tbody>
        <% if @users.any? %>
          <% @users.each do |user| %>
            <tr style="border-bottom: 1px solid #8b7355;" data-controller="row-link" data-row-link-url-value="<%= admin_user_path(user) %>">
              <td style="padding: 1rem;">
                <% unless user == current_user %>
                  <%= check_box_tag "user_ids[]", user.id, false, 
                      class: "user-checkbox", onchange: "updateBulkActions()" %>
                <% end %>
              </td>
              <td style="padding: 1rem;">
                <div>
                  <%= link_to admin_user_path(user), style: "color: inherit; text-decoration: none; font-weight: 700;" do %>
                    <span style="color: #3d2c1d;"><%= user.email %></span>
                  <% end %>
                  <% if user == current_user %>
                    <span style="background: #f0ebe4; color: #8b7355; padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem; margin-left: 0.5rem;">
                      You
                    </span>
                  <% end %>
                </div>
              </td>
              <td style="padding: 1rem;">
                <span style="background: #f0ebe4; 
                           color: #3d2c1d; 
                           padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.875rem; font-weight: 500;">
                  <%= user.role.humanize %>
                </span>
              </td>
              <td style="padding: 1rem; text-align: center;" data-sort-value="<%= user.current_streak %>">
                <div style="display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                  <span style="font-size: 1.1rem;"><%= user.streak_emoji %></span>
                  <span style="font-weight: 600; color: <%= user.current_streak > 0 ? '#ff6b35' : '#8b7355' %>;">
                    <%= user.current_streak %>
                  </span>
                </div>
              </td>
              <td style="padding: 1rem; text-align: center;" data-sort-value="<%= user.longest_streak %>">
                <span style="font-weight: 600; color: #8b7355;">
                  <%= user.longest_streak %>
                  <% if user.longest_streak > 7 %>
                    üèÜ
                  <% end %>
                </span>
              </td>
              <td style="padding: 1rem;">
                <span style="color: #8b7355; font-size: 0.875rem;">
                  <%= user.provider&.humanize || "Email" %>
                </span>
              </td>
              <td style="padding: 1rem;" data-sort-value="<%= user.created_at.iso8601 %>">
                <small style="color: #8b7355;">
                  <%= time_ago_in_words(user.created_at) %> ago
                  <br><%= user.created_at.strftime("%b %d, %Y") %>
                </small>
              </td>
              <td style="padding: 1rem;" data-sort-value="<%= user.current_sign_in_at&.iso8601 || '' %>">
                <small style="color: #8b7355; display:block;">
                  <% if user.current_sign_in_at %>
                    <%= time_ago_in_words(user.current_sign_in_at) %> ago
                    <br><%= user.current_sign_in_at.strftime("%b %d, %Y") %>
                  <% else %>
                    Never signed in
                  <% end %>
                </small>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" style="padding: 3rem; text-align: center; color: #6c757d;">
              <% if params[:search].present? || params[:role].present? %>
                No users found matching your criteria
                <br><br>
                <%= link_to "Clear filters", admin_users_path, 
                    style: "color: #007bff; text-decoration: none;" %>
              <% else %>
                No users found
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<script>
function toggleAll(checkbox) {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.user-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  selectedCount.textContent = checked.length;
  
  if (checked.length > 0) {
    bulkActions.style.display = 'block';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectAll = document.getElementById('select-all');
  selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
  selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
}

function clearSelection() {
  document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateBulkActions();
}
</script>
