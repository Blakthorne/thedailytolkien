<% content_for(:breadcrumb) do %>
   <strong>Users</strong>
<% end %>

<div class="admin-page-header">
  <h1 class="admin-page-title">Manage Users</h1>
  <div>
    <%= link_to "Export CSV", admin_users_path(format: :csv), class: "admin-nav-link" %>
  </div>
</div>

<!-- User Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Total Users</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Admins</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.admin.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Commentors</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= User.commentor.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">This Week</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #4a148c;"><%= User.where('created_at > ?', 1.week.ago).count %></p>
  </div>

  <div class="admin-stat-card">
    <h4 style="margin: 0;">Active Streaks</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #ff6b35;"><%= User.where('current_streak > 0').count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Max Streak</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #8b7355;"><%= User.maximum(:longest_streak) || 0 %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Avg Streak</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0; color: #6b46c1;"><%= User.average(:current_streak)&.round(1) || 0 %></p>
  </div>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_action_admin_users_path, method: :post, local: true, id: "bulk-form" do |f| %>
  <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border: 1px solid #8b7355;" id="bulk-actions">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
      <span style="color: #3d2c1d;">Selected: <strong id="selected-count">0</strong> users</span>
      <%= f.select :bulk_action, [
            ["Make Admin", "make_admin"],
            ["Make Commentor", "make_commentor"],
            ["Reset Streaks", "reset_streaks"],
            ["Recalculate Streaks", "recalculate_streaks"],
            ["Delete Selected", "delete"]
          ], { prompt: "Choose action..." },
          { style: "padding: 0.25rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      <%= f.submit "Apply", 
          style: "background: #8b4513; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;",
          onclick: "return confirm('Are you sure you want to perform this action on the selected users?')" %>
      <button type="button" onclick="clearSelection()" 
              style="background: #8b7355; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Search and Filter Bar -->
  <div class="admin-section" style="margin-bottom: 2rem;">
    <%= form_with url: admin_users_path, method: :get, local: true, 
        style: "display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;" do |f| %>
      <%= f.text_field :search, placeholder: "Search by email...", 
          value: params[:search],
          style: "flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
      <%= f.select :role, [["All Roles", ""], ["Admin", "admin"], ["Commentor", "commentor"]], 
          { selected: params[:role] },
          { style: "padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      <%= f.submit "Search", class: "admin-nav-link" %>
      <% if params[:search].present? || params[:role].present? %>
        <%= link_to "Clear", admin_users_path, class: "admin-nav-link" %>
      <% end %>
    <% end %>
  </div>

  <!-- Users Table -->
  <div class="app-table-section">
    <table class="app-table" data-controller="sortable-table" aria-describedby="users-table-caption">
      <caption id="users-table-caption" class="sr-only">Users table. Click on headers to sort. Click a row to view details.</caption>
        <thead>
          <tr>
            <th class="checkbox-cell">
              <input type="checkbox" id="select-all" onchange="toggleAll(this)" aria-label="Select all users">
            </th>
            <th class="col-priority-critical" data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Name</th>
            <th class="col-priority-critical" data-type="text" role="columnheader" tabindex="0" aria-sort="descending" style="outline: none;">Email</th>
            <th class="col-priority-high" data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Role</th>
            <th class="col-priority-medium" data-type="number" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Current Streak</th>
            <th class="col-priority-low" data-type="number" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Best Streak</th>
            <th class="col-priority-low" data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Provider</th>
            <th class="col-priority-medium" data-type="date" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Joined</th>
            <th class="col-priority-low" data-type="date" style="outline: none;">Last Seen</th>
          </tr>
        </thead>
        <tbody>
          <% if @users.any? %>
            <% @users.each do |user| %>
              <tr data-controller="row-link" data-row-link-url-value="<%= admin_user_path(user) %>" tabindex="0" aria-label="User: <%= user.full_name %>">
                <td class="checkbox-cell" data-label="Select">
                  <% unless user == current_user %>
                    <%= check_box_tag "user_ids[]", user.id, false, 
                        class: "user-checkbox", onchange: "updateBulkActions()", "aria-label": "Select #{user.full_name}" %>
                  <% end %>
                </td>
                <td class="col-priority-critical" data-label="Name">
                  <%= link_to admin_user_path(user), style: "color: inherit; text-decoration: none;" do %>
                    <span style="color: #3d2c1d; font-weight: 600;"><%= user.full_name %></span>
                  <% end %>
                </td>
                <td class="col-priority-critical" data-label="Email">
                  <div>
                    <%= link_to admin_user_path(user), style: "color: inherit; text-decoration: none; font-weight: 700;" do %>
                      <span style="color: #3d2c1d;"><%= user.email %></span>
                    <% end %>
                    <% if user == current_user %>
                      <span class="table-badge" style="margin-left: 0.5rem;">You</span>
                    <% end %>
                  </div>
                </td>
                <td class="col-priority-high" data-label="Role">
                  <span class="table-badge <%= 'table-badge-admin' if user.admin? %>">
                    <%= user.role.humanize %>
                  </span>
                </td>
                <td class="col-priority-medium" data-label="Current Streak" data-sort-value="<%= user.current_streak %>" style="text-align: center;">
                  <div style="display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                    <span style="font-size: 1.1rem;"><%= user.streak_emoji %></span>
                    <span style="font-weight: 600; color: <%= user.current_streak > 0 ? '#ff6b35' : '#8b7355' %>;">
                      <%= user.current_streak %>
                    </span>
                  </div>
                </td>
                <td class="col-priority-low" data-label="Best Streak" data-sort-value="<%= user.longest_streak %>" style="text-align: center;">
                  <span style="font-weight: 600; color: #8b7355;">
                    <%= user.longest_streak %>
                    <% if user.longest_streak > 7 %>
                      üèÜ
                    <% end %>
                  </span>
                </td>
                <td class="col-priority-low" data-label="Provider">
                  <span style="color: #8b7355; font-size: 0.875rem;">
                    <%= user.provider&.humanize || "Email" %>
                  </span>
                </td>
                <td class="col-priority-medium" data-label="Joined" data-sort-value="<%= user.created_at.iso8601 %>">
                  <small style="color: #8b7355;">
                    <%= time_ago_in_words(user.created_at) %> ago
                    <br><%= user.created_at.strftime("%b %d, %Y") %>
                  </small>
                </td>
                <td class="col-priority-low" data-label="Last Seen" data-sort-value="<%= user.current_sign_in_at&.iso8601 || '' %>">
                  <small style="color: #8b7355;">
                    <% if user.current_sign_in_at %>
                      <%= time_ago_in_words(user.current_sign_in_at) %> ago
                      <br><%= user.current_sign_in_at.strftime("%b %d, %Y") %>
                    <% else %>
                      Never signed in
                    <% end %>
                  </small>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="table-empty-state">
                <% if params[:search].present? || params[:role].present? %>
                  <h3>No users found matching your criteria</h3>
                  <p>
                    <%= link_to "Clear filters", admin_users_path, 
                        style: "color: #8b7355; text-decoration: none;" %>
                  </p>
                <% else %>
                  <h3>No users found</h3>
                  <p>This shouldn't normally happen!</p>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
  </div>
<% end %>

<%= content_tag :script, nonce: true do %>
function toggleAll(checkbox) {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.user-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  selectedCount.textContent = checked.length;
  
  if (checked.length > 0) {
    bulkActions.style.display = 'block';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.user-checkbox');
  const selectAll = document.getElementById('select-all');
  selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
  selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
}

function clearSelection() {
  document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateBulkActions();
}
<% end %>
