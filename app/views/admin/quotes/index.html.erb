<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > <strong>Quotes</strong>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>Manage Quotes</h1>
  <div>
    <%= link_to "Export CSV", admin_quotes_path(format: :csv), class: "admin-nav-link", 
        style: "margin-right: 0.5rem;" %>
    <%= link_to "Add New Quote", new_admin_quote_path, class: "admin-nav-link" %>
  </div>
</div>

<!-- Search and Filter Bar -->
<div class="admin-section" style="margin-bottom: 2rem;">
  <%= form_with url: admin_quotes_path, method: :get, local: true, 
      style: "display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;" do |f| %>
    <%= f.text_field :search, placeholder: "Search quotes or books...", 
        value: params[:search],
        style: "flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
    
    <%= f.select :tag_id, 
        options_from_collection_for_select(@tags, :id, :name, params[:tag_id]),
        { prompt: "Filter by tag..." },
        { style: "padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
    
    <%= f.submit "Filter", class: "admin-nav-link" %>
    
    <% if params[:search].present? || params[:tag_id].present? %>
      <%= link_to "Clear All", admin_quotes_path, class: "admin-nav-link" %>
    <% end %>
  <% end %>
  
  <% if params[:tag_id].present? %>
    <div style="margin-top: 1rem; padding: 0.75rem; background: #f0ebe4; border-radius: 4px; border-left: 3px solid #8b7355;">
      <p style="margin: 0; color: #3d2c1d;">
        <strong>Filtered by tag:</strong> 
        <span style="background: rgba(139, 115, 85, 0.15); padding: 0.25rem 0.5rem; border-radius: 8px;">
          <%= @tags.find(params[:tag_id]).name %>
        </span>
        <%= link_to "Clear filter", admin_quotes_path(search: params[:search]), 
            style: "color: #8b7355; text-decoration: underline; margin-left: 1rem;" %>
      </p>
    </div>
  <% end %>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_action_admin_quotes_path, method: :post, local: true, id: "bulk-form" do |f| %>
  <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border: 1px solid #8b7355;" id="bulk-actions">
    <div style="display: flex; gap: 1rem; align-items: center;">
      <span style="color: #3d2c1d;">Selected: <strong id="selected-count">0</strong> quotes</span>
      <%= f.select :bulk_action, [["Delete Selected", "delete"]], { prompt: "Choose action..." },
          { style: "padding: 0.25rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      <%= f.submit "Apply", 
          style: "background: #8b4513; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;",
          onclick: "return confirm('Are you sure you want to perform this action on the selected quotes?')" %>
      <button type="button" onclick="clearSelection()" 
              style="background: #8b7355; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Quotes Table -->
  <div class="admin-section">
  <table style="width: 100%; border-collapse: collapse;" data-controller="sortable-table" aria-describedby="quotes-table-caption">
      <caption id="quotes-table-caption" class="sr-only">Quotes table. Click on headers to sort. Click a row to view details.</caption>
      <thead style="background: #f0ebe4;">
        <tr>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">
            <input type="checkbox" id="select-all" onchange="toggleAll(this)">
          </th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Quote</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Book</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Chapter</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Character</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Tags</th>
          <th data-type="date" role="columnheader" tabindex="0" aria-sort="none" style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Created</th>
        </tr>
      </thead>
      <tbody>
        <% if @quotes.any? %>
          <% @quotes.each do |quote| %>
            <tr style="border-bottom: 1px solid #8b7355;" data-controller="row-link" data-row-link-url-value="<%= admin_quote_path(quote) %>">
              <td style="padding: 1rem;">
                <%= check_box_tag "quote_ids[]", quote.id, false, 
                    class: "quote-checkbox", onchange: "updateBulkActions()" %>
              </td>
              <td style="padding: 1rem;">
                <div style="max-width: 300px;">
                  <%= link_to admin_quote_path(quote), style: "color: inherit; text-decoration: none;" do %>
                    <p style="margin: 0; font-style: italic; color: #3d2c1d;">"<%= truncate(quote.text, length: 100) %>"</p>
                  <% end %>
                </div>
              </td>
              <td style="padding: 1rem;">
                <span style="font-weight: 500; color: #3d2c1d;"><%= quote.book %></span>
              </td>
              <td style="padding: 1rem; color: #3d2c1d;">
                <%= quote.chapter || "-" %>
              </td>
              <td style="padding: 1rem; color: #3d2c1d;">
                <%= quote.character || "-" %>
              </td>
              <td style="padding: 1rem;">
                <% if quote.tags.any? %>
                  <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                    <% quote.tags.limit(3).each do |tag| %>
                      <span style="background: rgba(139, 115, 85, 0.15); color: #3d2c1d; padding: 0.15rem 0.5rem; border-radius: 8px; font-size: 0.75rem; white-space: nowrap;">
                        <%= tag.name %>
                      </span>
                    <% end %>
                    <% if quote.tags.count > 3 %>
                      <span style="color: #8b7355; font-size: 0.75rem;">+<%= quote.tags.count - 3 %> more</span>
                    <% end %>
                  </div>
                <% else %>
                  <span style="color: #8b7355; font-style: italic; font-size: 0.85rem;">-</span>
                <% end %>
              </td>
              <td style="padding: 1rem;" data-sort-value="<%= quote.created_at.iso8601 %>">
                <small style="color: #8b7355; display:block;">
                  <%= time_ago_in_words(quote.created_at) %> ago
                </small>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="8" style="padding: 3rem; text-align: center; color: #8b7355;">
              <% if params[:search].present? %>
                No quotes found matching "<%= params[:search] %>"
                <br><br>
                <%= link_to "Clear search", admin_quotes_path, 
                    style: "color: #8b7355; text-decoration: none;" %>
              <% else %>
                No quotes found
                <br><br>
                <%= link_to "Add the first quote", new_admin_quote_path, 
                    style: "color: #8b7355; text-decoration: none;" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<script>
function toggleAll(checkbox) {
  const checkboxes = document.querySelectorAll('.quote-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.quote-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  selectedCount.textContent = checked.length;
  
  if (checked.length > 0) {
    bulkActions.style.display = 'block';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.quote-checkbox');
  const selectAll = document.getElementById('select-all');
  selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
  selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
}

function clearSelection() {
  document.querySelectorAll('.quote-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateBulkActions();
}
</script>
