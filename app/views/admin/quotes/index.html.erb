<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > <strong>Quotes</strong>
<% end %>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
  <h1>Manage Quotes</h1>
  <div>
    <%= link_to "Export CSV", admin_quotes_path(format: :csv), class: "admin-nav-link", 
        style: "margin-right: 0.5rem;" %>
    <%= link_to "Add New Quote", new_admin_quote_path, class: "admin-nav-link" %>
  </div>
</div>

<!-- Search and Filter Bar -->
<div class="admin-section" style="margin-bottom: 2rem;">
  <%= form_with url: admin_quotes_path, method: :get, local: true, 
      style: "display: flex; gap: 1rem; align-items: center;" do |f| %>
    <%= f.text_field :search, placeholder: "Search quotes or books...", 
        value: params[:search],
        style: "flex: 1; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
    <%= f.submit "Search", class: "admin-nav-link" %>
    <% if params[:search].present? %>
      <%= link_to "Clear", admin_quotes_path, class: "admin-nav-link" %>
    <% end %>
  <% end %>
</div>

<!-- Bulk Actions Form -->
<%= form_with url: bulk_action_admin_quotes_path, method: :post, local: true, id: "bulk-form" do |f| %>
  <div style="background: #f0ebe4; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; border: 1px solid #8b7355;" id="bulk-actions">
    <div style="display: flex; gap: 1rem; align-items: center;">
      <span style="color: #3d2c1d;">Selected: <strong id="selected-count">0</strong> quotes</span>
      <%= f.select :bulk_action, [["Delete Selected", "delete"]], { prompt: "Choose action..." },
          { style: "padding: 0.25rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      <%= f.submit "Apply", 
          style: "background: #8b4513; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;",
          onclick: "return confirm('Are you sure you want to perform this action on the selected quotes?')" %>
      <button type="button" onclick="clearSelection()" 
              style="background: #8b7355; color: white; padding: 0.25rem 1rem; border: none; border-radius: 4px; cursor: pointer;">
        Clear Selection
      </button>
    </div>
  </div>

  <!-- Quotes Table -->
  <div class="admin-section">
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="background: #f0ebe4;">
        <tr>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">
            <input type="checkbox" id="select-all" onchange="toggleAll(this)">
          </th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Quote</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Book</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Chapter</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Character</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Created</th>
          <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @quotes.any? %>
          <% @quotes.each do |quote| %>
            <tr style="border-bottom: 1px solid #8b7355;">
              <td style="padding: 1rem;">
                <%= check_box_tag "quote_ids[]", quote.id, false, 
                    class: "quote-checkbox", onchange: "updateBulkActions()" %>
              </td>
              <td style="padding: 1rem;">
                <div style="max-width: 300px;">
                  <p style="margin: 0; font-style: italic; color: #3d2c1d;">"<%= truncate(quote.text, length: 100) %>"</p>
                </div>
              </td>
              <td style="padding: 1rem;">
                <span style="font-weight: 500; color: #3d2c1d;"><%= quote.book %></span>
              </td>
              <td style="padding: 1rem; color: #3d2c1d;">
                <%= quote.chapter || "-" %>
              </td>
              <td style="padding: 1rem; color: #3d2c1d;">
                <%= quote.character || "-" %>
              </td>
              <td style="padding: 1rem;">
                <small style="color: #8b7355;">
                  <%= time_ago_in_words(quote.created_at) %> ago
                </small>
              </td>
              <td style="padding: 1rem;">
                <div style="display: flex; gap: 0.5rem;">
                  <%= link_to "View", admin_quote_path(quote), 
                      style: "color: #8b7355; text-decoration: none; font-size: 0.875rem;" %>
                  <%= link_to "Edit", edit_admin_quote_path(quote), 
                      style: "color: #8b6914; text-decoration: none; font-size: 0.875rem;" %>
                  <%= link_to "Delete", admin_quote_path(quote), method: :delete,
                      confirm: "Are you sure you want to delete this quote?",
                      style: "color: #8b4513; text-decoration: none; font-size: 0.875rem;" %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="7" style="padding: 3rem; text-align: center; color: #8b7355;">
              <% if params[:search].present? %>
                No quotes found matching "<%= params[:search] %>"
                <br><br>
                <%= link_to "Clear search", admin_quotes_path, 
                    style: "color: #8b7355; text-decoration: none;" %>
              <% else %>
                No quotes found
                <br><br>
                <%= link_to "Add the first quote", new_admin_quote_path, 
                    style: "color: #8b7355; text-decoration: none;" %>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>

<script>
function toggleAll(checkbox) {
  const checkboxes = document.querySelectorAll('.quote-checkbox');
  checkboxes.forEach(cb => cb.checked = checkbox.checked);
  updateBulkActions();
}

function updateBulkActions() {
  const checked = document.querySelectorAll('.quote-checkbox:checked');
  const bulkActions = document.getElementById('bulk-actions');
  const selectedCount = document.getElementById('selected-count');
  
  selectedCount.textContent = checked.length;
  
  if (checked.length > 0) {
    bulkActions.style.display = 'block';
  } else {
    bulkActions.style.display = 'none';
  }
  
  // Update select all checkbox state
  const allCheckboxes = document.querySelectorAll('.quote-checkbox');
  const selectAll = document.getElementById('select-all');
  selectAll.checked = allCheckboxes.length > 0 && checked.length === allCheckboxes.length;
  selectAll.indeterminate = checked.length > 0 && checked.length < allCheckboxes.length;
}

function clearSelection() {
  document.querySelectorAll('.quote-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateBulkActions();
}
</script>
