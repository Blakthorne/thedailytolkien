<% content_for(:breadcrumb) do %>
  <%= link_to "Dashboard", admin_root_path %> > <strong>Activity Log</strong>
<% end %>

<h1>Activity Log</h1>

<!-- Filters -->
<div class="admin-section" style="margin-bottom: 2rem;">
  <%= form_with url: admin_activity_logs_path, method: :get, local: true do |f| %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
      <div>
        <%= f.label :user_id, "Filter by User", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.select :user_id, 
            options_from_collection_for_select(@users, :id, :email, params[:user_id]),
            { prompt: "All users" },
            { style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      </div>
      
      <div>
        <%= f.label :action, "Filter by Action", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.select :action, 
            options_for_select(@actions.map { |action| [action.humanize, action] }, params[:action]),
            { prompt: "All actions" },
            { style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      </div>
      
      <div>
        <%= f.label :start_date, "From Date", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.date_field :start_date, 
            value: params[:start_date],
            style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
      </div>
      
      <div>
        <%= f.label :end_date, "To Date", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.date_field :end_date, 
            value: params[:end_date],
            style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
      </div>
    </div>
    
    <div style="display: flex; gap: 1rem;">
      <%= f.submit "Apply Filters", class: "admin-nav-link" %>
      <% if params.slice(:user_id, :action, :start_date, :end_date).values.any?(&:present?) %>
        <%= link_to "Clear Filters", admin_activity_logs_path, class: "admin-nav-link" %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Activity Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Total Activities</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Last 24 Hours</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.where('created_at > ?', 24.hours.ago).count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">This Week</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.where('created_at > ?', 1.week.ago).count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Showing</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= @activities.count %></p>
  </div>
</div>

<!-- Activity Log Table -->
<div class="admin-section">
  <table style="width: 100%; border-collapse: collapse;">
    <thead style="background: #f0ebe4;">
      <tr>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Time</th>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">User</th>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Action</th>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Target</th>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">IP Address</th>
        <th style="padding: 1rem; text-align: left; border-bottom: 1px solid #8b7355; color: #3d2c1d;">Details</th>
      </tr>
    </thead>
    <tbody>
      <% if @activities.any? %>
        <% @activities.each do |activity| %>
          <tr style="border-bottom: 1px solid #8b7355;">
            <td style="padding: 1rem; white-space: nowrap;">
              <div style="font-weight: 500; color: #3d2c1d;"><%= activity.created_at.strftime("%b %d, %Y") %></div>
              <small style="color: #8b7355;"><%= activity.created_at.strftime("%I:%M %p") %></small>
            </td>
            <td style="padding: 1rem;">
              <div style="font-weight: 500; color: #3d2c1d;"><%= activity.user.email %></div>
              <small style="color: #8b7355;">
                <span style="background: #f0ebe4; 
                           color: #3d2c1d; 
                           padding: 0.125rem 0.5rem; border-radius: 12px; font-size: 0.75rem;">
                  <%= activity.user.role.humanize %>
                </span>
              </small>
            </td>
            <td style="padding: 1rem;">
              <span style="background: #e6fffa; color: #234e52; padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.875rem; font-weight: 500;">
                <%= activity.action_description %>
              </span>
            </td>
            <td style="padding: 1rem;">
              <% if activity.target %>
                <div style="font-weight: 500; color: #2d3748;"><%= activity.target.class.name %></div>
                <small style="color: #6c757d;"><%= truncate(activity.target_description, length: 30) %></small>
              <% else %>
                <span style="color: #a0aec0;">—</span>
              <% end %>
            </td>
            <td style="padding: 1rem;">
              <small style="color: #6c757d; font-family: monospace;"><%= activity.ip_address || "—" %></small>
            </td>
            <td style="padding: 1rem;">
              <% if activity.details.present? %>
                <%= link_to "View", admin_activity_log_path(activity), 
                    style: "color: #007bff; text-decoration: none; font-size: 0.875rem;" %>
              <% else %>
                <span style="color: #a0aec0;">—</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="6" style="padding: 3rem; text-align: center; color: #6c757d;">
            <% if params.slice(:user_id, :action, :start_date, :end_date).values.any?(&:present?) %>
              No activity found matching your filters
              <br><br>
              <%= link_to "Clear filters", admin_activity_logs_path, 
                  style: "color: #007bff; text-decoration: none;" %>
            <% else %>
              No activity recorded yet
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if @activities.count == 200 %>
  <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
    <strong>Note:</strong> Showing the most recent 200 activities. Use filters to narrow down results.
  </div>
<% end %>
