<% content_for(:breadcrumb) do %>
   <strong>Activity Log</strong>
<% end %>

<div>
  <div class="admin-page-header">
    <h1 class="admin-page-title">Activity Log</h1>
  </div>

  <!-- Filters -->
  <div class="admin-section" style="margin-bottom: 2rem;">
  <%= form_with url: admin_activity_logs_path, method: :get, local: true do |f| %>
    <div class="activity-filters" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
      <style>
        @media (max-width: 768px) {
          .activity-filters {
            grid-template-columns: 1fr !important;
          }
        }
        @media (min-width: 769px) and (max-width: 1024px) {
          .activity-filters {
            grid-template-columns: repeat(2, 1fr) !important;
          }
        }
      </style>
      <div>
        <%= f.label :user_id, "Filter by User", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.select :user_id, 
            options_from_collection_for_select(@users, :id, :email, params[:user_id]),
            { prompt: "All users" },
            { style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      </div>
      
      <div>
        <%= f.label :activity_action, "Filter by Action", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.select :activity_action, 
            options_for_select(@actions.map { |action| [action.humanize, action] }, params[:activity_action]),
            { prompt: "All actions" },
            { style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" } %>
      </div>
      
      <div>
        <%= f.label :start_date, "From Date", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.date_field :start_date, 
            value: params[:start_date],
            style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
      </div>
      
      <div>
        <%= f.label :end_date, "To Date", style: "display: block; margin-bottom: 0.5rem; font-weight: 500; color: #3d2c1d;" %>
        <%= f.date_field :end_date, 
            value: params[:end_date],
            style: "width: 100%; padding: 0.5rem; border: 1px solid #8b7355; border-radius: 4px; background: #fefcfa;" %>
      </div>
    </div>
    
    <div style="display: flex; gap: 1rem;">
      <%= f.submit "Apply Filters", class: "admin-nav-link" %>
      <% if params.slice(:user_id, :activity_action, :start_date, :end_date).values.any?(&:present?) %>
        <%= link_to "Clear Filters", admin_activity_logs_path, class: "admin-nav-link" %>
      <% end %>
    </div>
  <% end %>
</div>

  <!-- Activity Stats -->
  <div class="activity-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
    <style>
      @media (max-width: 768px) {
        .activity-stats {
          grid-template-columns: repeat(2, 1fr) !important;
        }
      }
      @media (min-width: 769px) and (max-width: 1024px) {
        .activity-stats {
          grid-template-columns: repeat(4, 1fr) !important;
        }
      }
    </style>
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Total Activities</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Last 24 Hours</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.where('created_at > ?', 24.hours.ago).count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">This Week</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= ActivityLog.where('created_at > ?', 1.week.ago).count %></p>
  </div>
  
  <div class="admin-stat-card">
    <h4 style="margin: 0;">Showing</h4>
    <p style="font-size: 1.5rem; font-weight: bold; margin: 0.25rem 0;"><%= @activities.count %></p>
  </div>
</div>

  <!-- Activity Log Table -->
  <div class="app-table-section">
  <table class="app-table" data-controller="sortable-table" aria-describedby="activity-table-caption">
    <caption id="activity-table-caption" class="sr-only">Activity log table. Click on headers to sort. Click a row to view details.</caption>
    <thead>
      <tr>
        <th data-type="date" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Time</th>
        <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">User</th>
        <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Action</th>
        <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Target</th>
        <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">IP Address</th>
        <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Details</th>
      </tr>
    </thead>
    <tbody>
      <% if @activities.any? %>
        <% @activities.each do |activity| %>
          <tr data-controller="row-link" data-row-link-url-value="<%= h(admin_activity_log_path(activity)) %>" tabindex="0" aria-label="<%= h("Activity: #{activity.action_description}") %>">
            <td class="date-cell" data-sort-value="<%= activity.created_at.iso8601 %>">
              <div class="user-info"><%= activity.created_at.strftime("%b %d, %Y") %></div>
              <div class="secondary-info"><%= activity.created_at.strftime("%I:%M %p") %></div>
            </td>
            <td>
              <div class="user-info"><%= activity.user.email %></div>
              <div class="secondary-info">
                <span class="role-badge">
                  <%= activity.user.role.humanize %>
                </span>
              </div>
            </td>
            <td>
              <span class="status-badge">
                <%= activity.action_description %>
              </span>
            </td>
            <td>
              <% if activity.target %>
                <div class="user-info"><%= activity.target.class.name %></div>
                <div class="secondary-info"><%= truncate(activity.target_description, length: 30) %></div>
              <% else %>
                <span class="secondary-info">—</span>
              <% end %>
            </td>
            <td>
              <span class="monospace"><%= activity.ip_address || "—" %></span>
            </td>
            <td>
              <% if activity.details.present? %>
                <span class="secondary-info">Has details</span>
              <% else %>
                <span class="secondary-info">—</span>
              <% end %>
            </td>
          </tr>
        <% end %>
      <% else %>
        <tr>
          <td colspan="6" class="empty-state">
            <% if params.slice(:user_id, :activity_action, :start_date, :end_date).values.any?(&:present?) %>
              <h3>No activity found</h3>
              <p>No activity found matching your filters</p>
              <%= link_to "Clear filters", admin_activity_logs_path, class: "action-link" %>
            <% else %>
              <h3>No activity recorded</h3>
              <p>No activity has been recorded yet</p>
            <% end %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  </div>

  <% if @activities.count == 200 %>
    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
      <strong>Note:</strong> Showing the most recent 200 activities. Use filters to narrow down results.
    </div>
  <% end %>
</div>
