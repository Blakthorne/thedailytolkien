<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "The Daily Tolkien" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <style>
      /* ========================================
         CSS CUSTOM PROPERTIES & GLOBAL CONSTANTS
         ======================================== */
      :root {
        --parchment-bg: #f5f0e8;
        --parchment-overlay: rgba(245, 240, 232, 0.95);
        --text-primary: #3d2c1d;
        --text-secondary: #8b7355;
        --border-color: #8b7355;
        --border-subtle: rgba(139, 115, 85, 0.2);
        --gold-gradient: linear-gradient(135deg, #ffd700, #ffa500);
        --transition-fast: 0.2s ease;
        --transition-medium: 0.3s ease;
        --header-height: 60px;
        --mobile-header-height: 56px;
        --border-radius: 6px;
        --z-mobile-drawer: 999999;
        --z-mobile-toggle: 1000000;
      }

      /* ========================================
         GLOBAL RESET & BASE STYLES
         ======================================== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 16px;
      }

      body {
        font-family: 'Source Sans Pro', sans-serif;
        background-color: var(--parchment-bg);
        background-image: url(<%= asset_path 'scholarly-background-v4.svg' %>);
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        color: var(--text-primary);
        min-height: 100vh;
        line-height: 1.6;
        position: relative;
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        padding-top: 0;
      }

      body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(245, 240, 232, 0.1);
        z-index: -1;
      }

      .page-content {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      /* ========================================
         APP HEADER STYLES
         ======================================== */
      .app-header {
        background: rgba(245, 240, 232);
        padding: 1.5rem 2rem;
        border-bottom: 2px solid var(--border-color);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1200px;
        margin: 0 auto;
      }

      .app-header h1 {
        font-size: 1.75rem;
        color: var(--text-primary);
        margin: 0;
        letter-spacing: -0.025em;
      }

      .header-title-link {
        font-family: 'Crimson Text', serif;
        color: inherit;
        text-decoration: none;
        transition: color var(--transition-fast);
      }

      .header-title-link:hover {
        color: var(--text-secondary);
      }

      /* ========================================
         AUTHENTICATION & USER SECTION STYLES
         ======================================== */
      .auth-links {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        font-size: 0.9rem;
        color: var(--text-primary);
        font-weight: 500;
        opacity: 0.8;
        font-family: 'Source Sans Pro', sans-serif;
      }

      .auth-link {
        padding: 0.5rem 1rem;
        border-radius: var(--border-radius);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all var(--transition-fast);
        opacity: 0.8;
        font-family: 'Source Sans Pro', sans-serif;
      }

      .login-link {
        background: rgba(139, 115, 85, 0.1);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .login-link:hover {
        background: rgba(139, 115, 85, 0.2);
        color: var(--text-primary);
        opacity: 1;
      }

      .logout-link {
        background: rgba(61, 44, 29, 0.1);
        color: var(--text-primary);
        border: 1px solid var(--text-primary);
        cursor: pointer;
      }

      .logout-link:hover {
        background: rgba(61, 44, 29, 0.2);
        color: var(--text-primary);
        opacity: 1;
      }

      /* ========================================
         STREAK DISPLAY STYLES
         ======================================== */
      .user-section {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 1rem;
      }

      .streak-display {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(139, 115, 85, 0.1);
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        border: 1px solid var(--border-subtle);
      }

      .streak-emoji {
        font-size: 1.1rem;
      }

      .streak-text {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        font-family: 'Source Sans Pro', sans-serif;
      }

      .record-badge {
        background: var(--gold-gradient);
        color: var(--text-primary);
        padding: 0.1rem 0.4rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        border: 1px solid #ffd700;
        cursor: help;
      }



      /* ========================================
         MOBILE NAVIGATION SYSTEM
         ======================================== */

      /* Mobile Menu Toggle (Hamburger) */
      .mobile-menu-toggle {
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: none;
        border: none;
        padding: 0.5rem;
        cursor: pointer;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: var(--border-radius);
        transition: all var(--transition-fast);
        position: relative;
        z-index: var(--z-mobile-toggle);
      }

      .mobile-menu-toggle:hover {
        background: rgba(139, 115, 85, 0.1);
      }

      .mobile-menu-toggle:focus {
        outline: 2px solid var(--border-color);
        outline-offset: 2px;
      }

      .hamburger-line {
        display: block;
        width: 1.5rem;
        height: 2px;
        background: var(--text-primary);
        margin: 2px 0;
        transition: all var(--transition-medium);
        border-radius: 2px;
      }

      /* Hamburger to X animation */
      .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(1) {
        transform: translateY(6px) rotate(45deg);
      }

      .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(2) {
        opacity: 0;
      }

      .mobile-menu-toggle[aria-expanded="true"] .hamburger-line:nth-child(3) {
        transform: translateY(-6px) rotate(-45deg);
      }

      /* Mobile Drawer Container */
      .mobile-drawer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: var(--z-mobile-drawer);
        display: none;
      }

      .mobile-drawer.active {
        display: block;
      }

      .mobile-drawer-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1;
      }

      .mobile-drawer-content {
        position: absolute;
        top: 0;
        right: 0;
        width: 320px;
        max-width: 85vw;
        height: 100%;
        background: var(--parchment-bg);
        border-left: 2px solid var(--border-color);
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
        transform: translateX(100%);
        transition: transform 0.2s ease-out;
        display: flex;
        flex-direction: column;
        z-index: 2;
      }

      .mobile-drawer.active .mobile-drawer-content {
        transform: translateX(0);
      }

      /* Mobile Drawer Header */
      .mobile-drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid var(--border-subtle);
        background: rgba(139, 115, 85, 0.05);
      }

      .mobile-menu-title {
        margin: 0;
        font-size: 1.25rem;
        color: var(--text-primary);
        font-weight: 600;
        font-family: 'Crimson Text', serif;
      }

      .mobile-drawer-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: var(--border-radius);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        position: relative;
        z-index: 10;
      }

      .mobile-drawer-close:hover {
        background: rgba(139, 115, 85, 0.1);
        color: var(--text-primary);
      }

      .mobile-drawer-close:focus {
        outline: 2px solid var(--border-color);
        outline-offset: 2px;
      }

      .close-icon {
        font-size: 1.75rem;
        line-height: 1;
      }

      /* Mobile Drawer Body */
      .mobile-drawer-body {
        flex: 1;
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      /* Mobile User Info Section */
      .mobile-user-info {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .mobile-user-welcome h3 {
        margin: 0;
        font-size: 1.1rem;
        color: var(--text-primary);
        font-weight: 600;
        font-family: 'Crimson Text', serif;
      }

      .mobile-username {
        margin: 0;
        font-size: 1rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .mobile-streak-section {
        background: rgba(139, 115, 85, 0.08);
        border: 1px solid var(--border-subtle);
        border-radius: 12px;
        padding: 1.5rem;
      }

      .mobile-streak-display {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
      }

      .mobile-streak-emoji {
        font-size: 2rem;
        line-height: 1;
      }

      .mobile-streak-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .mobile-streak-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
      }

      .mobile-record-badge {
        background: var(--gold-gradient);
        color: var(--text-primary);
        padding: 0.5rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        border: 1px solid #ffd700;
        align-self: flex-start;
      }

      /* Mobile Guest Info */
      .mobile-guest-info {
        text-align: center;
        padding: 1rem 0;
      }

      .mobile-guest-info h3 {
        margin: 0 0 1rem 0;
        font-size: 1.2rem;
        color: var(--text-primary);
        font-weight: 600;
        font-family: 'Crimson Text', serif;
      }

      .mobile-guest-info p {
        margin: 0;
        color: var(--text-secondary);
        line-height: 1.5;
      }

      /* Mobile Action Buttons */
      .mobile-drawer-actions {
        margin-top: auto;
        padding-top: 1rem;
        border-top: 1px solid var(--border-subtle);
      }

      .mobile-logout-form {
        width: 100%;
      }

      .mobile-auth-btn {
        width: 100%;
        padding: 1rem;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        text-decoration: none;
        border: none;
        cursor: pointer;
        transition: all var(--transition-fast);
        text-align: center;
        display: block;
        font-family: 'Source Sans Pro', sans-serif;
      }

      .mobile-login-btn {
        background: var(--text-secondary);
        color: white;
        border: 2px solid var(--text-secondary);
      }

      .mobile-login-btn:hover {
        background: #6d5940;
        border-color: #6d5940;
        color: white;
      }

      .mobile-logout-btn {
        background: rgba(61, 44, 29, 0.1);
        color: var(--text-primary);
        border: 2px solid var(--text-primary);
      }

      .mobile-logout-btn:hover {
        background: var(--text-primary);
        color: white;
      }

      /* ========================================
         FOOTER STYLES
         ======================================== */
      .footer {
        width: 100%;
        height: 70px;
        padding: 0;
        border-top: 1px solid rgba(139, 115, 85, 0.3);
        background: rgba(245, 240, 232, 0.8);
        backdrop-filter: blur(10px);
      }

      .footer-content {
        max-width: 1200px;
        margin: auto;
        padding: 0 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        height: 100%;
      }

      .footer-content p {
        color: var(--text-primary);
        font-size: 0.9rem;
        margin: 0;
        opacity: 0.8;
      }

      .footer-nav {
        display: flex;
        gap: 2rem;
      }

      .footer-link {
        color: var(--text-primary);
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: color var(--transition-fast);
      }

      .footer-link:hover {
        color: var(--text-secondary);
      }

      /* ========================================
         LEGACY HEADER COMPATIBILITY
         ======================================== */
      .header {
        background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        padding: 2.5rem 2rem;
        text-align: center;
        position: sticky;
        top: 0;
        border-bottom: 1px solid #334155;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 100;
      }

      .header .nav-link {
        position: absolute;
        top: 1rem;
        left: 2rem;
        color: #64748b;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        padding: 0.5rem 1rem;
        border: 1px solid #334155;
        border-radius: 0.375rem;
        background: rgba(30, 41, 59, 0.8);
        backdrop-filter: blur(10px);
        transition: all var(--transition-fast);
      }

      .header .nav-link:hover {
        color: #e2e8f0;
        border-color: #475569;
        background: rgba(51, 65, 85, 0.8);
      }

      .header h1 {
        font-size: 2.25rem;
        font-weight: 700;
        color: #f1f5f9;
        margin-bottom: 0.5rem;
        letter-spacing: -0.025em;
      }

      .header p {
        color: #94a3b8;
        font-size: 1rem;
        margin: 0;
        font-weight: 400;
      }

      /* ========================================
         RESPONSIVE DESIGN & MEDIA QUERIES
         ======================================== */

      /* Mobile Breakpoint (768px and below) */
      @media (max-width: 768px) {
        .app-header {
          padding: 1rem 1.5rem;
        }

        .header-content {
          position: relative;
          display: flex;
          flex-direction: row;
          justify-content: space-between;
          align-items: center;
        }

        .mobile-menu-toggle {
          display: flex;
        }

        .header-right,
        .desktop-only {
          display: none;
        }

        .auth-links {
          justify-content: center;
        }

        .user-section {
          align-items: center;
          text-align: center;
        }

        .streak-display {
          font-size: 0.9rem;
        }

        .streak-text {
          font-size: 0.8rem;
        }

        .app-header h1 {
          font-size: 1.5rem;
        }

        .header {
          padding: 2rem 1rem;
        }

        .header .nav-link {
          position: static;
          margin-bottom: 1rem;
          display: inline-block;
        }

        .header h1 {
          font-size: 1.875rem;
        }

        .footer-content {
          flex-direction: column;
          text-align: center;
          justify-content: center;
          gap: 0;
          height: 100%;
          padding: 0;
        }

        .footer-nav {
          justify-content: center;
          gap: 1rem;
        }

        .mobile-drawer-header {
          padding: 1.25rem 1rem;
        }
      }

      /* Small Mobile Breakpoint (480px and below) */
      @media (max-width: 480px) {
        .app-header {
          padding: 0.75rem 1rem;
        }

        .app-header h1 {
          font-size: 1.2rem;
        }

        .mobile-drawer-header {
          padding: 1rem 1rem;
        }

        .mobile-drawer-content {
          width: 100%;
          max-width: 100vw;
        }

        .mobile-drawer-body {
          padding: 1.5rem 1rem;
        }
      }

      /* ========================================
         ACCESSIBILITY & MOTION PREFERENCES
         ======================================== */
      @media (prefers-reduced-motion: reduce) {
        .mobile-drawer-content,
        .hamburger-line,
        .mobile-menu-toggle,
        .mobile-drawer,
        .header-title-link,
        .auth-link,
        .mobile-auth-btn,
        .footer-link {
          transition: none;
        }
      }
    </style>

    <div class="page-content">
      <header class="app-header" data-controller="mobile-menu">
      <% if controller_path.start_with?('devise/') %>
        <div class="header-content">
          <h1><%= link_to "The Daily Tolkien", root_path, class: "header-title-link" %></h1>
        </div>
      <% else %>
        <div class="header-content">
          <h1><%= link_to "The Daily Tolkien", root_path, class: "header-title-link" %></h1>
          
          <!-- Mobile hamburger menu -->
          <button class="mobile-menu-toggle" 
                  data-action="click->mobile-menu#toggle"
                  aria-label="Open mobile menu"
                  aria-expanded="false">
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
            <span class="hamburger-line"></span>
          </button>
          
          <!-- Desktop auth links -->
          <div class="auth-links desktop-only">
            <% if user_signed_in? %>
              <span class="user-info">Welcome, <%= current_user.display_name %></span>
              <div class="user-section" data-user-timezone="<%= current_user.streak_timezone %>">
                <div class="streak-display">
                  <span class="streak-emoji"><%= current_user.streak_emoji %></span>
                  <span class="streak-text"><%= current_user.streak_display %></span>
                  <% if current_user.has_longest_streak_record? %>
                    <span class="record-badge" title="Personal Record: <%= current_user.longest_streak %> days">
                      🏆 <%= current_user.longest_streak %>
                    </span>
                  <% end %>
                </div>
                <%= form_with(url: destroy_user_session_path, method: :delete, data: { turbo: false }) do |f| %>
                  <%= f.submit "Logout", class: "auth-link logout-link" %>
                <% end %>
              </div>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "auth-link login-link" %>
            <% end %>
          </div>
        </div>
        
        <!-- Mobile drawer menu -->
        <div class="mobile-drawer" 
             data-mobile-menu-target="drawer"
             role="dialog"
             aria-modal="true"
             aria-hidden="true"
             aria-labelledby="mobile-menu-title">
          <div class="mobile-drawer-overlay" data-action="click->mobile-menu#close"></div>
          <div class="mobile-drawer-content">
            <div class="mobile-drawer-header">
              <h2 id="mobile-menu-title" class="mobile-menu-title">Menu</h2>
            </div>
            <div class="mobile-drawer-body">
              <% if user_signed_in? %>
                <div class="mobile-user-info">
                  <div class="mobile-user-welcome">
                    <h3>Welcome back <%= current_user.first_name %>!</h3>
                  </div>
                  <div class="mobile-streak-section">
                    <div class="mobile-streak-display">
                      <span class="mobile-streak-emoji"><%= current_user.streak_emoji %></span>
                      <div class="mobile-streak-info">
                        <span class="mobile-streak-text"><%= current_user.streak_display %></span>
                        <% if current_user.has_longest_streak_record? %>
                          <span class="mobile-record-badge" title="Personal Record: <%= current_user.longest_streak %> days">
                            🏆 Personal Record: <%= current_user.longest_streak %> days
                          </span>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mobile-drawer-actions">
                  <%= form_with(url: destroy_user_session_path, method: :delete, data: { turbo: false }, class: "mobile-logout-form") do |f| %>
                    <%= f.submit "Logout", class: "mobile-auth-btn mobile-logout-btn" %>
                  <% end %>
                </div>
              <% else %>
                <div class="mobile-guest-info">
                  <h3>Welcome to The Daily Tolkien</h3>
                  <p>Sign in to track your reading streak and join the community.</p>
                </div>
                <div class="mobile-drawer-actions">
                  <%= link_to "Login", new_user_session_path, class: "mobile-auth-btn mobile-login-btn" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </header>

    <%= yield %>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <p>&copy; <%= Date.current.year %> David Polar. All rights reserved.</p>
        <nav class="footer-nav">
          <a href="/" class="footer-link">Home</a>
          <a href="/archive" class="footer-link">Archive</a>
          <a href="/philosophy" class="footer-link">Philosophy</a>
          <% if user_signed_in? && current_user.admin? %>
            <%= link_to "Admin", admin_root_path, class: "footer-link" %>
          <% end %>
        </nav>
      </div>
    </footer>
  </body>
</html>
