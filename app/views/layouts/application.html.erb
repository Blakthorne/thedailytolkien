<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "The Daily Tolkien" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400;1,600;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

  <%# Main stylesheet entry point %>
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body>

    <div class="page-content">
      <header class="app-header" data-controller="mobile-menu">
      <% if controller_path.start_with?('devise/') %>
        <div class="header-content">
          <h1><%= link_to "The Daily Tolkien", root_path, class: "header-title-link" %></h1>
        </div>
      <% else %>
        <div class="header-content">
          <h1><%= link_to "The Daily Tolkien", root_path, class: "header-title-link" %></h1>
          
          <div style="display: flex; align-items: flex-end; gap: 1rem;">
            <% if user_signed_in? %>
              <div class="streak-display">
                <span class="streak-text"><%= current_user.streak_display %></span>
              </div>
            <% end %>
            
            <!-- Mobile hamburger menu -->
            <button class="mobile-menu-toggle" 
                    data-action="click->mobile-menu#toggle"
                    aria-label="Open mobile menu"
                    aria-expanded="false">
              <span class="hamburger-line"></span>
              <span class="hamburger-line"></span>
              <span class="hamburger-line"></span>
            </button>
          </div>
          
          <!-- Desktop auth links -->
          <div class="auth-links desktop-only">
            <%= link_to "Discover", discover_index_path, class: "header-button" %>
            <% if user_signed_in? %>
              <span class="user-info">Welcome, <%= current_user.display_name %></span>
              <div class="user-section" data-user-timezone="<%= current_user.streak_timezone %>">
                <% if current_user.has_longest_streak_record? %>
                  <span class="record-badge" title="Personal Record: <%= current_user.longest_streak %> days">
                    üèÜ <%= current_user.longest_streak %>
                  </span>
                <% end %>
                <%= form_with(url: destroy_user_session_path, method: :delete, data: { turbo: false }) do |f| %>
                  <%= f.submit "Logout", class: "header-button" %>
                <% end %>
              </div>
            <% else %>
              <%= link_to "Login", new_user_session_path, class: "header-button" %>
            <% end %>
          </div>
        </div>
        
        <!-- Mobile drawer menu -->
        <div class="mobile-drawer" 
             data-mobile-menu-target="drawer"
             role="dialog"
             aria-modal="true"
             aria-hidden="true"
             aria-labelledby="mobile-menu-title">
          <div class="mobile-drawer-overlay" data-action="click->mobile-menu#close"></div>
          <div class="mobile-drawer-content">
            <div class="mobile-drawer-header">
              <h2 id="mobile-menu-title" class="mobile-menu-title">Menu</h2>
            </div>
            <div class="mobile-drawer-body">
              <% if user_signed_in? %>
                <div class="mobile-user-info">
                  <div class="mobile-user-welcome">
                    <h3>Welcome back <%= current_user.first_name %>!</h3>
                  </div>
                  <% if current_user.has_longest_streak_record? %>
                    <span class="mobile-record-badge" title="Personal Record: <%= current_user.longest_streak %> days">
                      üèÜ Personal Record: <%= current_user.longest_streak %> days
                    </span>
                  <% end %>
                </div>
                <nav class="mobile-drawer-nav">
                  <%= link_to "Discover", discover_index_path, class: "mobile-nav-link" %>
                  <%= link_to "Philosophy", philosophy_path, class: "mobile-nav-link" %>
                  <% if current_user.admin? %>
                    <%= link_to "Admin", admin_root_path, class: "mobile-nav-link" %>
                  <% end %>
                </nav>
                <div class="mobile-drawer-actions">
                  <%= form_with(url: destroy_user_session_path, method: :delete, data: { turbo: false }, class: "mobile-logout-form") do |f| %>
                    <%= f.submit "Logout", class: "mobile-auth-btn mobile-logout-btn" %>
                  <% end %>
                </div>
              <% else %>
                <div class="mobile-guest-info">
                  <h3>Welcome to The Daily Tolkien</h3>
                  <p>Sign in to track your reading streak and join the community.</p>
                </div>
                <div class="mobile-drawer-actions">
                  <%= link_to "Login", new_user_session_path, class: "mobile-auth-btn mobile-login-btn" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </header>

    <%= yield %>
    </div>

    <footer class="footer">
      <div class="footer-content">
        <p>&copy; <%= Date.current.year %> David Polar. All rights reserved.</p>
        <nav class="footer-nav">
          <a href="/" class="footer-link">Home</a>
          <%= link_to "Discover", discover_index_path, class: "footer-link" %>
          <a href="/philosophy" class="footer-link">Philosophy</a>
          <% if user_signed_in? && current_user.admin? %>
            <%= link_to "Admin", admin_root_path, class: "footer-link" %>
          <% end %>
        </nav>
      </div>
    </footer>
  </body>
</html>
