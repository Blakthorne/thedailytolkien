<% content_for :title, "Quote Archive" %>



<main class="main-content">
  <!-- Archive Header -->
  <div class="archive-header">
    <h1>Quote Archive</h1>
    <p class="archive-subtitle">Browse previous quotes from The Daily Tolkien collection</p>
    <%= link_to "← Back to Today's Quote", root_path, class: "back-to-home" %>
  </div>

  <!-- Search and Filter Section -->
  <div class="search-section">
    <div class="search-header">
      <h2>Search & Filter Quotes</h2>
    </div>
    
    <%= form_with url: archive_index_path, method: :get, local: true, class: "search-form", id: "archive-filter-form" do |form| %>
      <div class="form-group">
        <%= form.label :search, "Search:", class: "form-label" %>
        <%= form.text_field :search, value: params[:search], placeholder: "Search quotes, books, characters...", class: "form-input" %>
      </div>
      
      <div class="form-group">
        <%= form.label :book, "Book:", class: "form-label" %>
        <%= form.select :book, options_for_select(@books.map { |book| [book, book] }, params[:book]), 
            { prompt: "All books" }, { class: "form-select" } %>
      </div>
      
      <div class="form-group">
        <%= form.label :character, "Character:", class: "form-label" %>
        <%= form.select :character, options_for_select(@characters.map { |char| [char, char] }, params[:character]), 
            { prompt: "All characters" }, { class: "form-select" } %>
      </div>
      
      <div class="form-group">
        <%= form.label :tag_id, "Tag:", class: "form-label" %>
        <%= form.select :tag_id, options_from_collection_for_select(@tags, :id, :name, params[:tag_id]), 
            { prompt: "All tags" }, { class: "form-select" } %>
      </div>
    <% end %>
    
    <div class="search-controls">
      <%= submit_tag "Filter", class: "btn btn-primary", form: "archive-filter-form" %>
      <%= link_to "Clear All", archive_index_path, class: "btn btn-secondary" %>
    </div>
    
    <% if params[:search].present? || params[:book].present? || params[:character].present? || params[:tag_id].present? %>
      <div class="active-filter">
        <p class="filter-info">
          <strong>Active filters:</strong>
          <% if params[:search].present? %>
            <span class="filter-tag">Search: "<%= params[:search] %>"</span>
          <% end %>
          <% if params[:book].present? %>
            <span class="filter-tag">Book: <%= params[:book] %></span>
          <% end %>
          <% if params[:character].present? %>
            <span class="filter-tag">Character: <%= params[:character] %></span>
          <% end %>
          <% if params[:tag_id].present? && @tags.find_by(id: params[:tag_id]) %>
            <span class="filter-tag">Tag: <%= @tags.find(params[:tag_id]).name %></span>
          <% end %>
        </p>
        <%= link_to "Clear all filters", archive_index_path, class: "clear-filter-link" %>
      </div>
    <% end %>
  </div>

  <!-- Table Section -->
  <div class="app-table-section">
    <table class="app-table" data-controller="sortable-table" aria-describedby="archive-table-caption">
      <caption id="archive-table-caption" class="sr-only">Archive table. Click on headers to sort. Click a row to view archived quote.</caption>
      <thead>
        <tr>
          <th data-type="date" role="columnheader" tabindex="0" aria-sort="descending" style="outline: none;">Date</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Quote</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Book</th>
          <th data-type="text" role="columnheader" tabindex="0" aria-sort="none" style="outline: none;">Character</th>
          <th style="outline: none;">Tags</th>
        </tr>
      </thead>
      <tbody>
        <% if @quotes.any? %>
          <% @quotes.each do |quote| %>
            <tr onclick="window.location.href='<%= archive_path(quote.archive_date.strftime('%Y-%m-%d')) %>'"
                data-sort-date="<%= quote.last_date_displayed %>">
              <td class="date-cell">
                <%= Time.at(quote.last_date_displayed).in_time_zone(@user_timezone).strftime('%B %d, %Y') %>
              </td>
              <td>
                <div class="quote-preview">
                  "<%= quote.archive_snippet(50) %>"
                </div>
              </td>
              <td>
                <strong><%= quote.book %></strong>
              </td>
              <td>
                <%= quote.character || "—" %>
              </td>
              <td>
                <% if quote.tags.any? %>
                  <div class="tag-list">
                    <% quote.tags.limit(3).each do |tag| %>
                      <span class="tag-badge"><%= tag.name %></span>
                    <% end %>
                    <% if quote.tags.count > 3 %>
                      <span class="tag-more">+<%= quote.tags.count - 3 %> more</span>
                    <% end %>
                  </div>
                <% else %>
                  <span style="color: #8b7355; font-style: italic;">—</span>
                <% end %>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <h3>
                  <% if params[:search].present? || params[:book].present? || params[:character].present? || params[:tag_id].present? %>
                    No quotes found matching your filters
                  <% else %>
                    No archived quotes found
                  <% end %>
                </h3>
                <p>
                  <% if params[:search].present? || params[:book].present? || params[:character].present? || params[:tag_id].present? %>
                    Try adjusting your search criteria or filters
                  <% else %>
                    Check back once quotes have been archived
                  <% end %>
                </p>
                <%= link_to "← View Today's Quote", root_path, class: "btn btn-primary" %>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <!-- Pagination Section -->
  <% if @quotes.respond_to?(:current_page) %>
    <div class="pagination-section">
      <div class="pagination">
        <% if @quotes.prev_page %>
          <%= link_to "‹ Previous", archive_index_path(page: @quotes.prev_page, **request.query_parameters.except(:page)), 
              class: "pagination-btn" %>
        <% end %>
        
        <span class="pagination-info">
          Page <%= @quotes.current_page %> of <%= @quotes.total_pages %>
          (<%= @quotes.total_count %> total quotes)
        </span>
        
        <% if @quotes.next_page %>
          <%= link_to "Next ›", archive_index_path(page: @quotes.next_page, **request.query_parameters.except(:page)), 
              class: "pagination-btn" %>
        <% end %>
      </div>
    </div>
  <% end %>
</main>


